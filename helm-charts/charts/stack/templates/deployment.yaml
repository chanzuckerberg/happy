apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    ad.datadoghq.com/tags: >-
      {"deployment_stage":"rdev","env":"rdev","happy_compute":"eks","happy_service":"along3-along","happy_stack":"along3","managedby":"happy","owner":"infra-eng@chanzuckerberg.com","project":"edu-platform","service":"happy"}
    linkerd.io/inject: disabled
  labels:
    app: along3-along
    app.kubernetes.io/component: along3-along
    app.kubernetes.io/managed-by: happy
    app.kubernetes.io/name: along3
    app.kubernetes.io/part-of: along3
  name: along3-along
  namespace: edu-platform-rdev-happy-happy-env
spec:
  progressDeadlineSeconds: 600
  replicas: 2
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: along3-along
  strategy:
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
    type: RollingUpdate
  template:
    metadata:
      annotations:
        ad.datadoghq.com/tags: >-
          {"deployment_stage":"rdev","env":"rdev","happy_compute":"eks","happy_service":"along3-along","happy_stack":"along3","managedby":"happy","owner":"infra-eng@chanzuckerberg.com","project":"edu-platform","service":"happy"}
      creationTimestamp: null
      labels:
        app: along3-along
        app.kubernetes.io/component: along3-along
        app.kubernetes.io/managed-by: happy
        app.kubernetes.io/name: along3
        app.kubernetes.io/part-of: along3
    spec:
      automountServiceAccountToken: true
      containers:
        - env:
            - name: DEPLOYMENT_STAGE
              value: rdev
            - name: AWS_REGION
              value: us-west-2
            - name: AWS_DEFAULT_REGION
              value: us-west-2
            - name: HAPPY_STACK
              value: along3
            - name: HAPPY_SERVICE
              value: along
            - name: HAPPY_CONTAINER
              value: along
            - name: ALONG_ENDPOINT
              value: https://along3.edu-platform.rdev.si.czi.technology
            - name: EXTERNAL_ALONG_ENDPOINT
              value: https://along3.edu-platform.rdev.si.czi.technology
            - name: PRIVATE_ALONG_ENDPOINT
              value: >-
                http://along3-along.edu-platform-rdev-happy-happy-env.svc.cluster.local:4000
            - name: APP_HOST
              value: along3.edu-platform.rdev.si.czi.technology
            - name: APP_NAME
              value: along3
            - name: CONNECTIONS_ENV
              value: test
            - name: DEPLOY_ENV_VERSION
              value: get-eks-version-from-hp
            - name: GIT_SHA
              value: 0cecd7467
            - name: RACK_ENV
              value: production
            - name: RAILS_ENV
              value: production
            - name: RAILS_LOG_TO_STDOUT
              value: enabled
            - name: RDEV_DEPLOY
              value: 'true'
            - name: RELEASE_CREATED_AT
              value: '2023-10-08T20:16:36-07:00'
            - name: RUN_IN_HAPPY_PATH
              value: 'true'
            - name: SCRUFFY_GIT_SHA
              value: b69e4f13edf1ade0deb0089c28909303de015afe
            - name: SDL_DATABASE_HOST
              value: >-
                edu-platform-rdev-happy-sdl.cluster-ciu2wiyqk18f.us-west-2.rds.amazonaws.com
            - name: SDL_DATABASE_NAME
              value: sdl
            - name: SDL_DATABASE_PASSWORD
              value: fpnuUHdqiiiB6cZFKUghb2ZEgzEa0t57
            - name: SDL_DATABASE_PORT
              value: '5432'
            - name: SDL_DATABASE_USER
              value: sdl
            - name: SECRET_KEY_BASE
              value: abc123
            - name: USE_THROW_SENTRY_ERROR
              value: 'true'
          envFrom:
            - secretRef:
                name: edu-platform-rdev-along-ssm-secrets
                optional: false
            - secretRef:
                name: postgresql-along3-credentials
                optional: false
            - secretRef:
                name: redis-along3-credentials
                optional: false
          image: >-
            254379453707.dkr.ecr.us-west-2.amazonaws.com/along3/rdev/along:sfitzgerald-chanzuckerberg.com-2023-10-09T02-54-43
          imagePullPolicy: IfNotPresent
          livenessProbe:
            failureThreshold: 3
            httpGet:
              path: /
              port: 4000
              scheme: HTTP
            initialDelaySeconds: 30
            periodSeconds: 3
            successThreshold: 1
            timeoutSeconds: 1
          name: along
          ports:
            - containerPort: 4000
              name: http
              protocol: TCP
          readinessProbe:
            failureThreshold: 3
            httpGet:
              path: /
              port: 4000
              scheme: HTTP
            initialDelaySeconds: 30
            periodSeconds: 3
            successThreshold: 1
            timeoutSeconds: 1
          resources:
            limits:
              cpu: '2'
              memory: 1Gi
            requests:
              cpu: 10m
              memory: 10Mi
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          volumeMounts:
            - mountPath: /var/happy
              mountPropagation: None
              name: integration-secret
              readOnly: true
      dnsPolicy: ClusterFirst
      enableServiceLinks: true
      nodeSelector:
        kubernetes.io/arch: amd64
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      serviceAccount: along-rdev-edu-platform
      serviceAccountName: along-rdev-edu-platform
      shareProcessNamespace: false
      terminationGracePeriodSeconds: 30
      volumes:
        - name: integration-secret
          secret:
            defaultMode: 420
            optional: false
            secretName: integration-secret
