on:
    push:
      branches:
        - main
        - alokshin/integration-test
name: integration-test
concurrency:
  group: ${{ github.workflow }}
jobs:
    integration-test:
      runs-on: ubuntu-latest
      permissions:
        id-token: write
        contents: read
      env:
        TFE_TOKEN: ${{ secrets.TFE_TOKEN_PLAYGROUND }}
      steps:
        - name: Assume happy-api deployement role
          uses: aws-actions/configure-aws-credentials@v2
          with:
            aws-region: us-west-2
            role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME_INTEGRATION_PLAYGROUND }}
            role-duration-seconds: 1200
            role-session-name: HappyCLIIntegrationTest
        # - id: install-aws-cli
        #   uses: unfor19/install-aws-cli-action@v1
        #   with:
        #     version: 2     
        #     verbose: false
        #     arch: amd64
        # - name: Identity info
        #   run: |
        #       aws sts get-caller-identity
        # - name: Update kube config
        #   run: | 
        #     aws eks update-kubeconfig --name si-playground-eks-v2 --alias si-playground-eks-v2 --region us-west-2
        #     kubectl config use-context si-playground-eks-v2
        # - uses: azure/setup-kubectl@v3
        # - name: Retrieve a list of nodes
        #   run: |
        #     kubectl get nodes
        - uses: actions/checkout@v3
        - uses: actions/setup-go@v3
          with:
            go-version-file: cli/go.mod
        - name: Cache Go modules
          uses: actions/cache@v3
          with:
            path: |
              ~/go/pkg/mod
            key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
            restore-keys: |
              ${{ runner.os }}-go-
        - name: Build CLI
          run: go build -o happy
          working-directory: ./cli
        - name: List stacks
          run: ../../cli/happy --detached --aws-profile="" list --output json
          working-directory: ./examples/integration_test
        - name: Build an image
          run: ../../cli/happy --detached --aws-profile="" build
          working-directory: ./examples/integration_test
        - name: Create a stack
          run: ../../cli/happy --detached --aws-profile="" create integration-test --force -v
          working-directory: ./examples/integration_test
        - name: List stacks
          run: |
            MATCHING_STACK_COUNT=$(../../cli/happy --detached --aws-profile="" list --output json | jq '[.[] | select(.Name=="integration-test")] | length')
            if [ "$MATCHING_STACK_COUNT" != "1" ]; then
              echo "Expected 1 stack, got $MATCHING_STACK_COUNT"
              exit 1
            else
              echo "Found 1 stack, as expected"
            fi
          working-directory: ./examples/integration_test
        - name: Push an image
          run: ../../cli/happy --detached --aws-profile="" push integration-test
          working-directory: ./examples/integration_test
        - name: Get events
          run: ../../cli/happy --detached --aws-profile="" events integration-test -v
          working-directory: ./examples/integration_test
        - name: Update a stack
          run: ../../cli/happy --detached --aws-profile="" update integration-test -v
          working-directory: ./examples/integration_test
        - name: Get stack logs
          run: ../../cli/happy --detached --aws-profile="" logs integration-test frontend -v
          working-directory: ./examples/integration_test
        - name: Get stack resources
          run: ../../cli/happy --detached --aws-profile="" resources integration-test -v
          working-directory: ./examples/integration_test
        - name: Get stack
          run: ../../cli/happy --detached --aws-profile="" get integration-test -v
          working-directory: ./examples/integration_test
        - name: Delete a stack
          run: ../../cli/happy --detached --aws-profile="" delete integration-test --force -v
          working-directory: ./examples/integration_test
        - name: List stacks
          run: |
            MATCHING_STACK_COUNT=$(../../cli/happy --detached --aws-profile="" list --output json | jq '[.[] | select(.Name=="integration-test")] | length')
            if [ "$MATCHING_STACK_COUNT" != "0" ]; then
              echo "Expected 0 stack, got $MATCHING_STACK_COUNT"
              exit 1
            else
              echo "Stack was deleted, as expected"
            fi
          working-directory: ./examples/integration_test

  